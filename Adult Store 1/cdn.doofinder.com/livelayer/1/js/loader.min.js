(()=>{var he=Object.defineProperty,me=Object.defineProperties;var fe=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var pe=Object.prototype.hasOwnProperty,_e=Object.prototype.propertyIsEnumerable;var O=(t,e,r)=>e in t?he(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,d=(t,e)=>{for(var r in e||(e={}))pe.call(e,r)&&O(t,r,e[r]);if(F)for(var r of F(e))_e.call(e,r)&&O(t,r,e[r]);return t},Y=(t,e)=>me(t,fe(e));var u=(t,e,r)=>new Promise((o,i)=>{var a=l=>{try{n(r.next(l))}catch(I){i(I)}},s=l=>{try{n(r.throw(l))}catch(I){i(I)}},n=l=>l.done?o(l.value):Promise.resolve(l.value).then(a,s);n((r=r.apply(t,e)).next())});var x=class{constructor(e={}){e=Object.assign({resolveTimeout:null,resolveValue:!0,rejectTimeout:null,rejectValue:!1},e),this._promise=new Promise((s,n)=>{this.resolve=s,this.reject=n}),this.then=this._promise.then.bind(this._promise),this.catch=this._promise.catch.bind(this._promise),this.finally=this._promise.finally.bind(this._promise),this[Symbol.toStringTag]="Promise";let{resolveTimeout:r,resolveValue:o,rejectTimeout:i,rejectValue:a}=e;r&&setTimeout(()=>this.resolve(o),r),i&&setTimeout(()=>this.reject(a),i)}};var D="layer",P="chat",C="quiz";function B(t){return t.reduce(function(e,r){return e[r]=new x,e},{})}function q(t){return function(e,r){return u(this,null,function*(){if(!t[e])throw new Error(`unknown "${e}" app!`);r(yield t[e])})}}var R="__DF_DEBUG_MODE__",z="true",h=window.sessionStorage;function Q(){h.setItem(R,z)}function M(){h.removeItem(R)}function $(){return h.getItem(R)===z}function p(t){return h.getItem(t)||window[t]}function _(t,e){h.setItem(t,e)}function L(...t){$()&&console.log("[doofinder]",...t)}var ge=10,ye=500;function J(t,e={}){let r=document.querySelector(t);return r?Promise.resolve(r):new Promise((o,i)=>{let a=0,s=null,n=e.interval||ye,l=e.times||ge;s=setInterval(function(){a++<l?(r=document.querySelector(t),r&&(clearInterval(s),o(r))):(clearInterval(s),i(`selector '${t}' not found`))},n)})}var G=3,X="df:trigger:click",Ee="df:trigger:focus",Se="df:trigger:input",Z="df:trigger:submit",T=class{constructor(e){this._minCaptureLength=G,this._elementSelector=e,this.__chooseTriggerElement__(e),this._eventBus=null,this._eventsQueue=[],this._events=[["click",this.handleClick.bind(this),!0],["focus",this.handleFocus.bind(this),!0],["input",this.handleInput.bind(this),!1],["submit",this.handleSubmit.bind(this),!0],["keypress",this.handleKeypress.bind(this),!0],["keyup",this.handleKeypress.bind(this),!0],["keydown",this.handleKeypress.bind(this),!0]],this._handleSubmit=!1,this._enabled=!1,this._redirection=null}__chooseTriggerElement__(e){this._element=Array.from(document.querySelectorAll(e)).find(r=>r.offsetWidth>0&&r.offsetHeight>0)}updateQuery(e=""){return u(this,null,function*(){let r=yield this.getElement();r instanceof HTMLInputElement&&(r.value=e)})}setCaptureLength(e){this._minCaptureLength=e||G}getElement(){return u(this,null,function*(){if(!!this._enabled){if(!this._element)try{this._element=yield J(this._elementSelector)}catch(e){this._element=void 0}return this._element}})}get enabled(){return this._enabled}set enabled(e){if(this._enabled!==!!e){this._enabled=!!e;let r=document[`${this._enabled?"add":"remove"}EventListener`];this._events.forEach(o=>r(...o))}}get captureSubmit(){return this._handleSubmit}set captureSubmit(e){this._handleSubmit=!!e}get redirection(){if(this._redirection)return d({},this._redirection)}set redirection(e){this._redirection=e}setEventBus(e){this._eventBus=e}flushMessages(){var e;if(this._eventsQueue=[...new Map(this._eventsQueue).entries()],this._eventsQueue.length>0){let r=this._eventsQueue.shift();for(;r&&r.length===2;)L("trigger:emit",r),(e=this._eventBus)==null||e.emit(...r),r=this._eventsQueue.shift()}else document.activeElement===this._element&&this.notify(X,this.getPayload())}destroy(){this._events.forEach(e=>window.removeEventListener(...e))}shouldHandle(e){let r=this.getElementFromEvent(e);return r?(this._element=r,!0):!1}getPayload(e){let r={source:this._element,originalEvent:e};if(this._element instanceof HTMLInputElement){let o=this._element.value.trim();o.length>=this._minCaptureLength&&(r.query=o)}return r}getElementFromEvent(e){if(!e.target||e.target===document||e.target===window)return;let r=e.type==="submit"?"querySelector":"closest",o=e.target[r](this._elementSelector);if(o&&!o.closest("[dfd-hook]"))return o}handleClick(e){this.shouldHandle(e)&&(e.preventDefault(),e.stopImmediatePropagation(),this.notify(X,this.getPayload(e)))}handleFocus(e){this.shouldHandle(e)&&(e.stopImmediatePropagation(),this.notify(Ee,this.getPayload(e)))}handleInput(e){this.shouldHandle(e)&&this.notify(Se,this.getPayload(e))}handleSubmit(e){this._handleSubmit&&this.shouldHandle(e)&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this.notify(Z,this.getPayload(e)))}handleKeypress(e){e.key==="Enter"&&this.shouldHandle(e)&&(!!this._redirection||this._handleSubmit)&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),this._redirection?window.location=this._redirection.url:e.type==="keydown"&&this.notify(Z,this.getPayload(e)))}notify(e,r){this._eventBus?this._eventBus.emit(e,r):this._eventsQueue.push([e,r]),L("[trigger]",this._eventBus?"[emit]":"[queue]",e,r)}};var W={canPushState(){return typeof history.pushState!="undefined"},dropLocal(t,e,r){return t.removeItem(this.localKey(e,r))},updateLocal(t,e,r,o,i){let a=this.getLocal(t,e,r),s=this.localKey(e,r),n=a===null?o:i(a);return t.setItem(s,JSON.stringify(n)),n},getLocal(t,e,r){return JSON.parse(t.getItem(this.localKey(e,r)))},updateCurrentState(t){!this.canPushState()||history.replaceState(t(history.state||{}),"",window.location.href)},pushState(t,e,r){if(this.canPushState()){if(r!==window.location.href){if(e.type=="redirect"&&e.scroll){let i=history.state||{};i.scroll=e.scroll,history.replaceState(i,"",window.location.href)}delete e.scroll,history[t+"State"](e,"",r||null);let o=this.getHashTargetEl(window.location.hash);o?o.scrollIntoView():e.type==="redirect"&&window.scroll(0,0)}}else this.redirect(r)},setCookie(t,e){document.cookie=`${t}=${e}`},getCookie(t){return document.cookie.replace(new RegExp(`(?:(?:^|.*;s*)${t}s*=s*([^;]*).*$)|^.*$`),"$1")},redirect(t,e){e&&W.setCookie("__phoenix_flash__",e+"; max-age=60000; path=/"),window.location=t},localKey(t,e){return`${t}-${e}`},getHashTargetEl(t){let e=t.toString().substring(1);if(e!=="")return document.getElementById(e)||document.querySelector(`a[name="${e}"]`)}},g=W;function U(t){let e=document.cookie.match(new RegExp("(?:^|; )"+t.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g,"\\$1")+"=([^;]*)"));if(e)return decodeURIComponent(e[1])}var be=24*60*60*1e3,k="df",ee="random-userid",y="random-sessid",E="random-sessid-expiry",A=window.localStorage,we={get userId(){return m(ee)},set userId(t){return j(ee,t)},get sessionId(){let t=m(y),e=m(E);if(!!t&&!!e&&e<=new Date().getTime())ve();else return t},set sessionId(t){let e=m(y),r=m(E);e!==t&&(e=t,r=new Date().getTime()+be),j(y,e),j(E,r)}};function m(t){return g.getLocal(A,k,t)}function j(t,e){return g.updateLocal(A,k,t,e,()=>e)}function te(t){return g.dropLocal(A,k,t)}function ve(){te(y),te(E)}var f=we;var H=Object.freeze({language(t){let[e,r]=(t==null?void 0:t.replace("_","-").trim().split("-"))||[];return e&&r?`${e.toLowerCase()}-${r.toUpperCase()}`:e==null?void 0:e.toLowerCase()},currency(t){return t==null?void 0:t.trim().toUpperCase()}});function re(){return p("__DF_CDN_PREFIX__")}function S(t,e=!1){let r=p("__DF_LAYER_SERVER__")||`https://${t.toLowerCase()}-layer.doofinder.com`;return e?r.replace(/^http/,"ws"):r}var oe=1;function ie(){var e;let t=[];return c(t,"source_url",encodeURIComponent(window.location.href)),c(t,"session_id",f.sessionId),c(t,"user_id",f.userId),c(t,"ga_client_id",(e=U("_ga"))==null?void 0:e.substring(6)),c(t,"vsn","1.4.131"),t}function c(t,e,r){r!=null&&(typeof r!="string"||!!r.trim())&&t.push(`${e}=${r}`)}function Ie(t){var l;let{installationId:e,zone:r,language:o,currency:i}=t,s=`${S(r)}/api/${oe}/installation/${e}`,n=[];return c(n,"source_url",encodeURIComponent(window.location.href)),c(n,"session_id",f.sessionId),c(n,"user_id",f.userId),c(n,"language",H.language(o||document.documentElement.getAttribute("lang"))||""),c(n,"currency",H.currency(i)||""),c(n,"ga_client_id",(l=U("_ga"))==null?void 0:l.substring(6)),c(n,"vsn","1.4.131"),`${s}?${n.join("&")}`}function N(t){let e=re()||t.cdn_prefix,r=t.vsn,o=i=>`${e}${i}?vsn=${r}`;return $()&&(t.js=t.js.map(i=>i.replace(/\.min\.js/i,".js"))),t.css=t.css.map(o),t.js=t.js.map(o),t}function ne(t){return new Promise(function(e,r){fetch(Ie(t),{redirect:"follow"}).then(function(o){o.ok?o.json().then(function(i){e(N(i))}):r(`HTTP ${o.status} error response from server`)}).catch(o=>r(o))})}function se(t){return u(this,null,function*(){let{chat_id:e,zone:r}=t,o=`${S(r)}/chat/${e}`,i=ie(),s=yield(yield fetch(`${o}?${i.join("&")}`,{redirect:"follow"})).json();return N(s)})}function ae(t){return u(this,null,function*(){let{quiz_id:e,zone:r}=t,o=`${S(r)}/quiz/${e}`,i=ie(),s=yield(yield fetch(`${o}?${i.join("&")}`,{redirect:"follow"})).json();return N(s)})}function b(t){return u(this,null,function*(){if(!document.querySelector(`script[src="${t}"]`)){let e=document.createElement("script");e.src=t,e.async=1,document.head.appendChild(e)}})}function w(t){return u(this,null,function*(){if(!document.querySelector(`link[rel="stylesheet"][href="${t}"]`)){let e=document.createElement("link");e.setAttribute("rel","stylesheet"),e.setAttribute("href",t),document.head.appendChild(e)}})}function K(t){return u(this,null,function*(){let e=document.createElement("style");e.appendChild(document.createTextNode((t||"").trim())),document.head.appendChild(e)})}function le(t,e){let r=e.options,o=t.hashid||r.hashid,{autoload:i}=e,a="urlHash"in t?!!t.urlHash:!!r.url_hash;return delete t.urlHash,delete r.url_hash,Y(d(d({},t),r),{autoload:i,urlHash:a,hashid:o})}function ce(t){return _("__DF_CDN_PREFIX__",t)}function ue(t){return _("__DF_LAYER_SERVER__",t)}function v(){try{decodeURIComponent(location.href)}catch(t){throw new Error("invalid UTF-8 on url-encoded query params")}}var de=B([D,P,C]),V=q(de);document.addEventListener("doofinder.register",t=>{let{name:e,entrypoint:r}=t.detail;de[e].resolve(r)});var xe={vsn:"1.4.131",load(t,e){v(),ne(t).then(r=>{var i;r.css.forEach(w),r.custom_css.forEach(K);let o=(i=r.custom_properties)==null?void 0:i.join(`
`);t=le(t,r),t.trigger=De(t),V(D,function(a){let s=a.create(t);K(`#${s.mount.id} {
${o||""}
}`),typeof e=="function"&&e(s)}),r.js.forEach(b)}).catch(r=>{console.error("[Doofinder] error retrieving resources:",r)})},loadChat(t,e){v(),se(t).then(r=>{r.css.forEach(w),V(P,function(o){let i=o.create(t);typeof e=="function"&&e(i)}),r.js.forEach(b)})},loadQuiz(t,e){v(),ae(t).then(r=>{r.css.forEach(w),V(C,function(o){let i=o.create(t);typeof e=="function"&&e(i)}),r.js.forEach(b)})},enableDebug:Q,disableDebug:M,setLayerServerUrl:ue,setCDNServerUrl:ce};function De(t){let{autoload:e,trigger:r}=t,o=new T(r);return o.enabled=!e||e.trigger,o}window.doofinderLoader=xe;})();
